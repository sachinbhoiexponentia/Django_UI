<!DOCTYPE html>
<html>
    {% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&family=Open+Sans:wght@400;500;600&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<link rel="stylesheet" type="text/css" href="{% static 'pc_styles.css' %}">
<link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

<style>
  .popup{
    width: 400px;
    background: #fff;
    border-radius: 6px;
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.1);
    text-align: center;
    padding: 24px;
    border: 1px solid #736CEB;
    box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.2);
    font-size: 18px;
    display: none;
    transition: transform 0.4s, top 0.4s;
}
.showPopup{
  display: block;
  top: 50%;
  transform: translate(-50%, -50%) scale(1);
}
.popup p{
  margin-bottom: 24px;
}

.update{
  background-color: #736CEB !important;
}
.update:hover{
  box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.2);
}


.custom-modal-body {
    padding-left: 35px;
    /* Adjust the left padding as needed */
    padding-right: 35px;
    /* Adjust the right padding as needed */
}


.hand-cursor {
    cursor: pointer;
}
</style>


</head>





<body>

  <header>
    <div class="left-buttons">
      <button></button>
      <h1 style="margin-left: 56px;">Product Category Config</h1>
    </div>

    <div class="right-buttons">
      {% comment %} <button class="button-images_noti" style="margin-right: -30px;"><img src="{% static 'Vector2.png' %}"></button> {% endcomment %}
      
      {% comment %} <button class="button-images_admin" style=" margin-right: 5px; padding-right: 20px;"><img src="{% static 'Group 8.png' %}"></button> {% endcomment %}
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <form method="post" action="{% url 'logout' %}" >
      {% csrf_token %}
      <button type="submit" style="background-color: #7c7cec; color: white;">Logout</button>
      </form>
    
    </div>
  </header>
  <div>
    <div class="sidebar">
        <a href="/product_cat_conf"><img src="{% static 'Ellipse 4.png' %}" alt="Product Category Icon"> Product Category</a>
      <a href="/"><img src="{% static 'Ellipse 4.png' %}" alt="Home Icon"> Threshold Logic</a>
      <a href="/closure_Config_view"><img src="{% static 'Ellipse 4.png' %}" alt="Services Icon"> Task Closure</a>
      <a href="/TNT_Module_View"><img src="{% static 'Ellipse 4.png' %}" alt="Clients Icon"> TNT Module</a>
      <a href="/TOAM_Module_View">
        <div class="d-flex">
          <div>
            <img src="{% static 'Ellipse 4.png' %}" alt="Contact Icon">
          </div>
          <div>Task Optimization & Assignment Module</div>
        </div>
      </a>
      {% comment %} <a href="/"><img src="{% static 'Ellipse 4.png' %}" alt="Con Icon"> Deploy Config</a> {% endcomment %}
    </div>
    <div class="content">
      <div class="button-container">
        <!-- <div class="tab"> -->
        <button class="tablinks" onclick="openCity(event, 'London')">Product Category Config</button>

      </div>


      <br><br>
      {% if messages %}
        <ul class="messages">
          {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      <div class="button-container_">

        <div id="London" class="tabcontent">


          <div class="button1-container">
            <button class="button-with-image blueBorder ms-auto" id="formButton1" data-toggle="modal"
              data-target="#myModal1"><span><img src="{% static 'add.png' %}" class="me-1"></span>Add New</button>
            <button class="button-with-image1"><span><img src="{% static 'Download.png' %}" class="me-1"><a href="/download/Product_Category_Config" style="color: white; text-decoration: none;">Download</a></button>
            {% comment %} <button class="button-with-image2" onclick="uploadToS3('Task_Closure_Config')"><span><img src="{% static 'Upload.png' %}" class="me-1">Upload</button> {% endcomment %}
          </div>
          <div class="table-container">
            <table class="custom-table">
                <thead>
                    <tr>
                     
                      {% for header in Product_Category_Config_headers %}
                      <th>{{ header }}</th>
                      {% endfor %}
                      <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                  {% for row in Product_Category_Config_data%}
                       <tr>
                        {% for value in row %}
                          <td>
                             {{value}}
                          </td>
                         
                        {% endfor %}
                        <td>
                          <i class="fas fa-edit hand-cursor" id="editButton3" onclick="getSourceData_PCC('{{row.0}}')" data-toggle="modal"
                      data-target="#modal_task_closure_form_edit" style="color: black;"></i>
                    <i class="fas fa-trash-alt hand-cursor" id="deleteButton5" onclick="deleteConfirmation('{{ row.0 }}')"
                      data-toggle="modal" style="color: black;"></i>

                      <div class="popup" style="display: block;" id="deletePopup_{{row.0}}">
                        <p>Do you want to delete row {{ row.0 }}?</p>
                        <button class="btn btn-outline-danger cancel me-4" onclick="closePopup('{{ row.0 }}')">Cancel</button>
                        <button class="btn btn-primary update" onclick="DeleteSourceData_PCC('{{ row.0 }}')">Yes, Delete </button>
                      </div>

                        </td>
                       </tr>
                  {% endfor %}
                </tbody>
            </table>
          </div>
          {% comment %} <div class="button2-container"><button class="button-image ms-auto">Validate</button></div> {% endcomment %}

          <div id="myModal1" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">
                <!-- Modal content-->
                  <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title">Add New</h1>
                        <button type="button" class="close" data-dismiss="modal">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="product_cat_conf_add_form" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="form_identifier" value="product_cat_conf_add_form">
                                    <div class="form-row">
                                        <div class="form-group_thre">
                                            <label for="ProductCategoryName" class="label1_">ProductCategoryName</label>
                                            <input class="first1" name="ProductCategoryName" id="ProductCategoryName" type="text" placeholder="ProductCategoryName">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group_thre">
                                            <label for="FilterQueryOnPolicyTable" class="label1_">FilterQueryOnPolicyTable</label>
                                            <div id="filterQueryTable">
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Criteria</th>
                                                            <th>Comparison</th>
                                                            <th>Value</th>
                                                            <th>AND/OR</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Initial row for FilterQueryOnPolicyTable -->
                                                        <tr>
                                                            <td>
                                                                <select class="form-control" name="FilterQueryOnPolicyTable[criteria][]">
                                                                    <option value=""></option>
                                                                    <option value="p_np_ul">p_np_ul</option>
                                                                    <option value="BILLFREQ">BILLFREQ</option>
                                                                    <option value="PREMIUM_PAYING_TERM">PREMIUM_PAYING_TERM</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select class="form-control" name="FilterQueryOnPolicyTable[comparison][]">
                                                                    <option value=""></option>
                                                                    <option value=">">></option>
                                                                    <option value="<"><</option>
                                                                    <option value=">=">>=</option>
                                                                    <option value="<="><=</option>
                                                                    <option value="!">!</option>
                                                                    <option value="=">=</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <input type="text" class="form-control" name="FilterQueryOnPolicyTable[value][]" placeholder="Enter Value">
                                                            </td>
                                                            <td>
                                                                <select class="form-control andOrDropdown" name="FilterQueryOnPolicyTable[and_or][]">
                                                                    <option value=""></option>
                                                                    <option value="AND">AND</option>
                                                                    <option value="OR">OR</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-danger" onclick="deleteRow(this)">-</button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="addNewRow()">Add Filter Query Row</button>
                                        </div>
                                    </div>


                                    <div class="form-row">
                                        <div class="form-group_thre">
                                            <label for="TrainingTopics" class="label1_">TrainingTopics</label>
                                            <input class="first1" name="TrainingTopics" id="TrainingTopics" type="text" placeholder="TrainingTopics">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group_thre">
                                            <label for="SellingTaskNo" class="label1_">SellingTaskNo</label>
                                            <input class="first1" name="SellingTaskNo" id="SellingTaskNo" type="text" placeholder="SellingTaskNo">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group_thre">
                                            <label for="TrainingTaskNo" class="label1_">TrainingTaskNo</label>
                                            <input class="first1" name="TrainingTaskNo" id="TrainingTaskNo" type="text" placeholder="TrainingTaskNo">
                                        </div>
                                    </div>
                            <button type="button" id="validateButton_closure" class="btn btn-info btn-lg submit_validate" style="background-color: #736CEB; color: #fff;" data-toggle="modal">
                                Validate
                            </button>
                        </form>
                    </div>
                </div>
            </div>
          </div>

        </div>

        <div id="submit_closure_view" class="modal fade" role="dialog">
          <div class="modal-dialog modal-md">

            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title" style="font-size: 15px; color: black;">Validate</h1>
                <button type="button" class="close" data-dismiss="modal"
                  style="border: 1px; height: 5px;">&times;</button>

              </div>
              <div class="modal-body">
                <p style="color: black;">Do you want to add new channel?</p>
                <button type="button" id="submit_button__closure" style="background-color:#736CEB; color: white;" class="btn btn-info btn-lg" >Submit</button>
              </div>
            </div>
          </div>
        </div>



          <div id="modal_task_closure_form_edit" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">
              <!-- Modal content-->


              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title">Edit</h1>
                  <button type="button" class="close" data-dismiss="modal">×</button>

                </div>
                <div class="modal-body custom-modal-body">
                    <form id="product_cat_conf_edit_form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" id="product_cat_conf_edit_form" name="form_identifier" value="product_cat_conf_edit_form">
                        <div class="form-row">
                            <div class="form-group_thre">
                            <input class="first1" name="id_edit" id="id_edit" type="hidden" value="18">
                        <div class="form-row">
                            <div class="form-group_thre">
                            
                            <label for="ProductCategoryName" class="label1_">ProductCategoryName</label>
                            <input class="first1" name="ProductCategoryName_edit" id="ProductCategoryName_edit" type="text" placeholder="ProductCategoryName">
                            </div>
                          </div>
                        <div class="form-row">
                            <div class="form-group_thre">
                            
                            <label for="FilterQueryOnPolicyTable" class="label1_">FilterQueryOnPolicyTable</label>
                            <input class="first1" name="FilterQueryOnPolicyTable_edit" id="FilterQueryOnPolicyTable_edit" type="text" placeholder="FilterQueryOnPolicyTable">
                            </div>
                          </div>
                        <div class="form-row">
                            <div class="form-group_thre">
                            <label for="TrainingTopics" class="label1_">TrainingTopics</label>
                            <input class="first1" name="TrainingTopics_edit" id="TrainingTopics_edit" type="text" placeholder="TrainingTopics">
                            </div>
                          </div>
                        <div class="form-row">
                            <div class="form-group_thre">
                            
                            <label for="SellingTaskNo" class="label1_">SellingTaskNo</label>
                            <input class="first1" name="SellingTaskNo_edit" id="SellingTaskNo_edit" type="text" placeholder="SellingTaskNo">
                            </div>
                          </div>
                        <div class="form-row">
                            <div class="form-group_thre">
                            <label for="TrainingTaskNo" class="label1_">TrainingTaskNo</label>
                            <input class="first1" name="TrainingTaskNo_edit" id="TrainingTaskNo_edit" type="text" placeholder="TrainingTaskNo">
                            </div>
                          </div>
                    <div class="text-center">    
                    <button type="submit" id="validateButton_threshold_logic_config" class="btn btn-info" data-toggle="modal" data-form-id="modal_task_closure_form" style="background-color: #736CEB; color: #fff;">Submit</button>
                    </div>
                </div>
              </div></form>
            </div>
          </div>



            </div>
      </div>
    </div>

  </div>



  <div>
  </div>

  </div>
  </div>



  <div id="error_closure" class="modal fade" role="dialog">
  <div class="modal-dialog modal-md">
      <div class="modal-content">
          <div class="modal-header">
              <h1 class="modal-title" style="font-size: 15px; color: black;">Validate</h1>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
              <p style="color: black;">Error in validation, please check input values</p>
              <button type="button" id="error_button__threshold_logic_config" style="background-color: red; color: white;">OK</button>
          </div>
      </div>
  </div>
  </div>


  <script>
    function openCity(evt, cityName) {

      var i, tabcontent, tablinks;


      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }


      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }


      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    let deletePopup = document.getElementById("deletePopup");

    function deleteConfirmation(rowId){
      //deletePopup.classList.add("showPopup")
    var deletePopup = document.getElementById("deletePopup_" + rowId);
    deletePopup.classList.add("showPopup");
      //alert(rowId)
    }

    function closePopup(rowId){
      var deletePopup = document.getElementById("deletePopup_" + rowId);
      deletePopup.classList.remove("showPopup")
    }


$(document).ready(function () {
  $('#validateButton_closure').on('click', function (event) {
    event.preventDefault(); // Prevent the default form submission
    var formData = $('#product_cat_conf_add_form').serialize();
    formData += '&csrfmiddlewaretoken=' + $('input[name=csrfmiddlewaretoken]').val();
    $.ajax({
      type: 'GET',
      url: '/api/validate_thresold_config_df/',
      data: formData,
      dataType: 'json',
      success: function (response) {
        if (response.is_valid) {
          // Handle success (e.g., update UI, show a message)
          $('#submit_closure_view').modal('show');
        } else {
          // Show the errors in the error modal
          $('#error_closure .modal-body p').html(response.errors.join('<br>'));
          $('#error_closure').modal('show');
        }
      },
      error: function (xhr, status, error) {
        console.error('AJAX request failed with error:', error);
        alert('Internal Server Error. Please check the server logs for details.');
      }
    });
  });
});






$(document).ready(function () {
    $('#submit_button__closure').on('click', function () {
        $('#product_cat_conf_add_form').submit();
    });
});


$(document).ready(function() {
  $('#error_button__threshold_logic_config').on('click', function() {
    $('#error_closure').modal('hide');
  });
});













function getSourceData_PCC(rowId) {

$(document).ready(function () {
  var apiUrl = `api/pcc_get_data/${rowId}`;
  $.ajax({
    url: apiUrl,
    type: 'GET',
    dataType: 'json',
    success: function (data) {
      document.getElementById("id_edit").value = rowId
      document.getElementById("ProductCategoryName_edit").value = data.ProductCategoryName
      document.getElementById("FilterQueryOnPolicyTable_edit").value = data.FilterQueryOnPolicyTable
      document.getElementById("TrainingTopics_edit").value = data.TrainingTopics
      document.getElementById("SellingTaskNo_edit").value = data.SellingTaskNo
      document.getElementById("TrainingTaskNo_edit").value = data.TrainingTaskNo
    }
  });
});

}

function DeleteSourceData_PCC(row_id) {
  document.getElementById(`deletePopup_${row_id}`).style.display = "none";

fetch(`api/pcc_delete/${row_id}/`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
})
  .then(response => {
    if (!response.ok) {
      if (response.status === 404) {
        // Show errorDiv if object not found
        document.getElementById('errorDiv').style.display = 'block';
      } else {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
    } else {
      // Show successDiv on successful deletion
      window.alert = function(message){
              const alert = document.createElement('div');
              const alertButton = document.createElement('button');
              alertButton.innerHTML="OK";
              alert.classList.add('popup', 'showPopup');
              alertButton.classList.add('btn', 'btn-primary');
              alert.innerHTML= `<p>${message}</p>`;
              alert.appendChild(alertButton);
              alertButton.addEventListener('click', (e)=>{
                alert.remove();
              })
              document.body.appendChild(alert);

            }
            
      alert(`Row ${row_id} deleted successfully`);
      $('#myModal_delete_AP').modal('show');
      return response.json();
    }
  })
  .catch(error => {
    // Handle other errors
    console.error('Error deleting data:', error);
    // Show errorDiv on other errors
    document.getElementById('errorDiv').style.display = 'block';
  });
}


function uploadToS3(sheetName) {
    // Make a GET request to the server endpoint with the sheet name
    fetch(`/upload/${sheetName}/`, {
        method: 'GET',
        headers: {
            // No need for 'Content-Type' header in GET requests
            // 'Content-Type': 'application/json',
            // Add any other headers if needed
        },
    })
    .then(response => response.json())
    .then(data => {
        // Handle the response from the server
        if (data.is_valid) {
            // Show success alert
            alert('Uploaded successfully');
        } else {
            // Show failure alert
            alert('Upload failed');
        }
        // Add any additional logic or UI updates based on the response
    })
    .catch(error => {
        // Handle errors
        console.error('Error:', error);
        // Show an error alert or handle the error in another way
        alert('Error uploading data. Please try again.');
    });
  };













    $(document).ready(function() {
        // Add new row on AND/OR selection change
        $('#filterQueryTable').on('change', '.andOrDropdown', function() {
            var selectedValue = $(this).val();
            if (selectedValue === 'AND' || selectedValue === 'OR') {
                addNewRow();
            }
        });
    });

    function addNewRow() {
        var newRow = '<tr>' +
            '<td>' +
                '<select class="form-control" name="FilterQueryOnPolicyTable[criteria][]">' +
                    '<option value=""></option>' +
                    '<option value="p_np_ul">p_np_ul</option>' +
                    '<option value="BILLFREQ">BILLFREQ</option>' +
                    '<option value="PREMIUM_PAYING_TERM">PREMIUM_PAYING_TERM</option>' +
                '</select>' +
            '</td>' +
            '<td>' +
                '<select class="form-control" name="FilterQueryOnPolicyTable[comparison][]">' +
                    '<option value=""></option>' +
                    '<option value=">">></option>' +
                    '<option value="<"><</option>' +
                    '<option value=">=">>=</option>' +
                    '<option value="<="><=</option>' +
                    '<option value="!">!</option>' +
                    '<option value="=">=</option>' +
                '</select>' +
            '</td>' +
            '<td>' +
                '<input type="text" class="form-control" name="FilterQueryOnPolicyTable[value][]" placeholder="Enter Value">' +
            '</td>' +
            '<td>' +
                '<select class="form-control andOrDropdown" name="FilterQueryOnPolicyTable[and_or][]">' +
                    '<option value=""></option>' +
                    '<option value="AND">AND</option>' +
                    '<option value="OR">OR</option>' +
                '</select>' +
            '</td>' +
            '<td>' +
                '<button type="button" class="btn btn-danger" onclick="deleteRow(this)">-</button>' +
            '</td>' +
        '</tr>';

        $('#filterQueryTable tbody').append(newRow);
    }

    function deleteRow(button) {
        $(button).closest('tr').remove();
    }

    function downloadCSV() {
        // Get values from the form
        var productCategoryName = 'non_par_c2p';
        var filterQueryData = getFilterQueryData();
        var trainingTopics = 'HDFC Life Sanchay Plus Quiz';
        var sellingTaskNo = $('[name="selling_task_no"]').val();
        var trainingTaskNo = $('[name="training_task_no"]').val();

        // Create CSV content
        var csvContent = 'Product Category Name,Filter Query on Policy Table,Training Topics,Selling Task no,Training Task no\n';
        csvContent += `${productCategoryName},"${filterQueryData}",${trainingTopics},${sellingTaskNo},${trainingTaskNo}\n`;

        // Create a Blob object and create a download link
        var blob = new Blob([csvContent], { type: 'text/csv' });
        var link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = 'product_category_data.csv';
        link.click();
    }

    function getFilterQueryData() {
        var filterQueryData = '';
        $('#filterQueryTable tbody tr').each(function() {
            var criteria = $(this).find('[name="FilterQueryOnPolicyTable[criteria][]"]').val();
            var comparison = $(this).find('[name="FilterQueryOnPolicyTable[comparison][]"]').val();
            var value = $(this).find('[name="FilterQueryOnPolicyTable[value][]"]').val();
            var andOr = $(this).find('[name="FilterQueryOnPolicyTable[and_or][]"]').val();
            filterQueryData += `${criteria} ${comparison} ${value} ${andOr} `;
        });
        return filterQueryData.trim();
    }







  </script>

</body>

</html>